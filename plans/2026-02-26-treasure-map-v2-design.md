# 寻宝地图 V2 — 任务系统与地图增强设计

基于 MVP 寻宝地图页面，新增每日任务系统、世界消息跑马灯、活动入口，并引入项圈色个性化视觉体系。

---

## 设计目标

1. **留存 / 日活**：每日任务给用户打开 app 的理由
2. **探索引导**：任务条提示最近宝箱方向，降低"找不到宝箱"的挫败感
3. **成就感 / 长期目标**：完成全部任务 → 解锁任务宝箱，比随机开箱更有仪式感
4. **氛围感**：跑马灯营造"很多人在玩"的热闹氛围

---

## 页面布局

```
┌─────────────────────────────────┐
│ [系统状态栏]                      │
├─────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ [今日+85分] [3/10] [券包🔴]  │ │  ← 顶部状态栏（不变）
│ └─────────────────────────────┘ │
│ ┌─────────────────────────────┐ │
│ │ 🎉 恭喜小明开出稀有宝箱！    → │ │  ← 跑马灯（新增）
│ └─────────────────────────────┘ │
│                                 │
│         全 屏 地 图              │
│                                 │
│      📦230m        🎁380m       │
│              🐕                  │
│   📦可开启        🎯任务宝箱     │
│                                 │
│                          [🎉]  │  ← 活动按钮（新增，条件显示）
│                          [📍]  │  ← 定位按钮
│ [筛选]                          │
│ ┌─────────────────────────────┐ │
│ │ 🐾 今日任务 1/3  最近: 东230m │ │  ← 任务条（新增）
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│ [首页] [寻宝✓] [轨迹] [我的]    │
└─────────────────────────────────┘
```

---

## 新增元素详细规格

### N1: 跑马灯（世界消息）

- 位置：顶部状态栏正下方，左右 16px
- 尺寸：高 28px，圆角 8px
- 样式：半透明黑底 rgba(0,0,0,0.5)，backdrop-blur 8px
- 左侧固定图标 🎉（不滚动），与滚动文字间距 6px
- 文字：13px 白色，单行，从右向左匀速滚动，速度约 50px/s
- 每条消息滚完后间隔 2 秒显示下一条
- 无消息时隐藏，不占空间

**消息类型：**

| 类型 | 示例 | 频率 |
|------|------|------|
| 开箱播报 | "小明 刚开出了稀有宝箱！" | 高 |
| 商家券播报 | "汪汪 领取了萌宠屋优惠券" | 中 |
| 任务完成 | "Lucky 完成了今日全部任务 🎯" | 低 |
| 运营公告 | "本周末双倍积分活动开启！" | 运营配置 |

**交互：**
- 运营公告类型：点击跳转活动页
- 其他类型：不响应点击
- 用户名显示昵称，脱敏处理

### N2: 任务条

- 位置：Tab 栏正上方，左右 16px，底部间距 12px
- 尺寸：高 44px，圆角 12px
- 样式：白色 90% 不透明度，backdrop-blur 12px，阴影 0 2px 12px rgba(0,0,0,0.08)

**三种状态：**

**未开始态：**
- 内容："🐾 今日寻宝任务 ▸"
- 🐾 图标颜色跟随项圈色
- 右侧箭头 ▸ 暗示可展开
- 点击 → 展开任务卡片

**进行中态：**
- 内容："🐾 1/3 进行中  最近: 东北230m"
- 左侧 🐾 用项圈色
- 进度文字后跟方向提示（最近可开启宝箱的罗盘方位 + 距离）
- 进度条：底部 3px 填充条，颜色跟随项圈色，宽度 = 完成比例
- 点击 → 展开任务卡片查看详情

**全部完成态：**
- 内容："🎯 任务完成！领取奖励宝箱"
- 项圈色光环脉冲（同活动按钮风格）
- 点击 → 地图上生成任务宝箱（用户附近 50m 内）

### N3: 任务卡片（Bottom Sheet）

- 触发：点击任务条
- 位置：从底部滑出，约屏幕 1/3 高度
- 样式：白色背景，顶部圆角 16px，拖拽条

**内容布局：**

```
┌─────────────────────────────────┐
│              ───                 │  ← 拖拽条
│  今日寻宝任务               1/3  │  ← 标题 + 总进度
│                                 │
│  ☑ 开启 3 个宝箱        +20 积分 │  ← 已完成项（项圈色勾）
│  ☐ 遛狗满 15 分钟  8:32  +15 积分 │  ← 进行中（显示实时计时）
│  ☐ 探索商家宝箱          任务宝箱 │  ← 未完成（奖励为任务宝箱）
│                                 │
│  ┌─────────────────────────────┐│
│  │           出发              ││  ← 主按钮（未开始时）
│  └─────────────────────────────┘│
└─────────────────────────────────┘
```

- 标题："今日寻宝任务"，16px 加粗
- 总进度：右上角 "1/3"，14px，项圈色
- 每个任务项高 48px：
  - 左：复选框（完成时填充项圈色 + 白色勾）
  - 中：任务名 15px #333 + 实时进度（计时/计数）13px #999
  - 右：奖励标签（积分显示数值；任务宝箱显示 🎯 图标）
- "出发"按钮：仅未开始时显示，项圈色渐变背景，白字 "出发"，圆角 24px，高 44px
- 进行中时无按钮，卡片纯展示进度

**关闭方式：** 点击遮罩 / 下滑拖拽

### N4: 活动按钮

- 位置：右下角，定位按钮正上方，间距 12px
- 尺寸：44×44 圆形
- 样式：白色背景，阴影 0 2px 12px rgba(0,0,0,0.08)，🎉 图标 20px 居中
- 外圈光环：项圈色，宽 2px，脉冲动画（opacity 50%-100%，1.5s 循环）
- 右上角红点：有新活动未查看时显示，8×8
- 点击：跳转运营活动 H5 页面（WebView，带导航栏返回）
- 无活动期间：完全隐藏
- 入场动画：新活动上线时从右侧滑入（0.3s）+ 弹跳（0.2s）

### N5: 任务宝箱（地图标记）

- 触发：全部任务完成后，点击任务条时生成
- 位置：用户当前位置附近 50m 内随机点
- 图标：🎯 34px，外圈项圈色光环脉冲（同稀有宝箱风格，但颜色跟随项圈色）
- 下方标注："任务奖励" 12px，项圈色
- 开箱动画：同普通开箱，但粒子特效颜色跟随项圈色
- 奖励：30-80 积分（比普通积分宝箱 5-20 丰厚）
- 每日限一个（对应每日任务）

---

## 每日任务系统规则

### 任务生成

- 每日凌晨 00:00 自动为每个用户生成 3 个任务
- 从任务池随机抽取，不可刷新不可跳过
- 同一天不重复同类任务

### 任务池（MVP）

| 任务 | 条件变体 | 奖励 | 抽取权重 |
|------|---------|------|---------|
| 开启 N 个宝箱 | N = 3 或 5 | +20 / +40 积分 | 高 |
| 遛狗满 N 分钟 | N = 15 或 30 | +15 / +30 积分 | 高 |
| 探索商家宝箱 | 开启 1 个商家宝箱 | +25 积分 | 中 |
| 行走 N 米 | N = 500 或 1000 | +10 / +20 积分 | 中 |

### 进度规则

- **被动累计**：用户正常开宝箱、遛狗行为自动计入进度，无需额外操作
- "出发"按钮是心理仪式，不影响计数——即使不点"出发"，开宝箱也会计入任务
- 进度实时更新，每次状态变化刷新任务条显示
- 当日 23:59 未完成的任务自动过期，不累计到次日

### 任务宝箱

- 全部 3 个任务完成后解锁
- 生成在用户当前位置附近 50m 内
- 奖励：30-80 随机积分
- 每日限 1 个任务宝箱
- 当日未领取则次日凌晨消失

### 与现有积分体系的关系

- 任务奖励积分计入每日 200 分上限
- 任务宝箱积分也计入上限
- 任务宝箱开启计入顶部状态栏的宝箱进度 (n/10)

---

## 项圈色个性化视觉体系

### 设计原则

项圈是用户购买的实体硬件产品，UI 中的项圈色映射用户的真实装备，建立数字与物理的连接。高端项圈在 UI 上有可见的差异化，间接激励硬件销售。

### 色系定义（3-5 种，每种精调）

| 项圈系列 | 主色值 | 光环色 | 粒子色 | 适配气质 |
|---------|--------|--------|--------|---------|
| 经典红 | #E74C3C | rgba(231,76,60,0.4) | #FF6B6B, #FF3B30 | 热情活力 |
| 海洋蓝 | #3498DB | rgba(52,152,219,0.4) | #6BC5E8, #4A90D9 | 沉稳可靠 |
| 森林绿 | #27AE60 | rgba(39,174,96,0.4) | #6FCF97, #34C759 | 自然清新 |
| 尊享金 | #F1C40F | rgba(241,196,15,0.4) | #FFD700, #FFB800 | 高端尊贵 |
| 暗夜黑 | #2C3E50 | rgba(44,62,80,0.3) | #BDC3C7, #ECF0F1 | 低调高级（银白粒子） |

### 应用位置

| UI 元素 | 项圈色应用方式 |
|---------|--------------|
| 活动按钮 | 外圈光环脉冲 |
| 任务条 | 🐾 图标颜色 + 底部进度条填充色 |
| 任务卡片 | 复选框填充色 + "出发"按钮渐变背景 + 进度数字 |
| 任务宝箱 | 地图标记外圈光环 + 开箱粒子特效 |
| 定位按钮 | 按下时涟漪扩散色 |
| 筛选按钮 | 不应用（纯工具按钮，保持克制） |

### 无项圈 / 默认态

未绑定项圈的用户使用默认主题金色（#FFB800），与积分体系视觉一致。

---

## 交互规则补充

| 操作 | 响应 |
|------|------|
| 点击任务条（未开始） | 展开任务卡片 |
| 点击"出发" | 收起卡片，任务条变为进行中态 |
| 完成单个任务 | toast "✅ {任务名} +{n}分"，任务条进度更新 |
| 全部任务完成 | 任务条变为完成态 + 脉冲光环，toast "🎉 今日任务全部完成！" |
| 点击完成态任务条 | 地图上生成任务宝箱，任务条变为 "🎯 任务宝箱已出现" |
| 开启任务宝箱 | 项圈色粒子开箱动画 → 积分奖励 Bottom Sheet |
| 点击活动按钮 | WebView 打开活动 H5 |
| 点击跑马灯（运营公告） | 跳转活动页 |
| 点击跑马灯（其他） | 无响应 |

---

## 版本记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-02-26 | 任务系统 + 跑马灯 + 活动入口 + 项圈色体系 |
